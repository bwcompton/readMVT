<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="readMVT">
<title>shiny-example • readMVT</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="shiny-example">
<meta property="og:description" content="readMVT">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">readMVT</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/shiny-example.html">shiny-example</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/bwcompton/readMVT/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>shiny-example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/bwcompton/readMVT/blob/HEAD/vignettes/shiny-example.Rmd" class="external-link"><code>vignettes/shiny-example.Rmd</code></a></small>
      <div class="d-none name"><code>shiny-example.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="using-readmvt-in-leaflet-under-shiny">Using readMVT in Leaflet under Shiny<a class="anchor" aria-label="anchor" href="#using-readmvt-in-leaflet-under-shiny"></a>
</h2>
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>Although Leaflet for R can display very large image or raster data
seamlessly with little effort it is far more limited in displaying
vector data. The built-in methods require that your datasets be small
enough to fit in the client’s browser memory, and datasets of more than
a very few thousand points are prohibitively slow to load.</p>
<p>One nice approach to displaying vector data is via <a href="https://docs.mapbox.com/data/tilesets/guides/vector-tiles-introduction/" class="external-link">Mapbox
Vector Tiles</a> (MVT) served by a <a href="https://geoserver.org/" class="external-link">GeoServer</a>. Tiling is done
transparently on the GeoServer, so data prep doesn’t require a lot of
effort. The readMVT package facilitates fetching and displaying MVTs in
Leaflet. It is intended to be run under Shiny, but can be used in
simpler situations too.</p>
<p>This example displays vector stream data and road-stream crossings
for Massachusetts, USA. It doesn’t display the vector data until the
user has zoomed to a specified level, for two reasons. First, there’s no
value in seeing points representing some 30,000 culverts and bridges
when viewing the entire state. And second, loading large tiles at lower
zoom levels would be prohibitively slow. When the user reaches the
trigger zoom level, streams and crossings are displayed. They are
continually loaded as the user zooms and pans above the trigger zoom.
When the user zooms below the trigger level, the vector data are dropped
from the display.</p>
<p>To speed things up considerably, data are cached at two levels.
First, we use the package <em>memoise</em> to cache tiles as they are
fetched from the GeoServer. If there are multiple client browsers under
the same R session on a Shiny server, this cache is shared among users,
so the same tile is never fetched from the GeoServer twice by the same R
session. Second, Leaflet internally caches data drawn by the add*
functions (here, [leaflet::addPolylines()] and
[leaflet::addCircleMarkers()]). We track (by user, not session) which
tiles have been drawn so they don’t need to be redrawn for a user.</p>
<p>If you want to try running this example, we’ve provided it in one big
chunk at the bottom, all ready to be copied and pasted into a
script.</p>
</div>
<div class="section level3">
<h3 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h3>
<p>We start with some setup. First of all, we load the required
packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bwcompton/readMVT" class="external-link">readMVT</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.posit.co/" class="external-link">shiny</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/leaflet/" class="external-link">leaflet</a></span><span class="op">)</span></span></code></pre></div>
<p>Now we set our home centerpoint and zoom level. The chosen values
show all of Massachusetts.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">home</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">71.6995</span>, <span class="fl">42.1349</span><span class="op">)</span>  <span class="co"># center of Massachusetts</span></span>
<span><span class="va">zoom</span> <span class="op">&lt;-</span> <span class="fl">8</span>                     <span class="co"># starting zoom level (shows all of Massachusetts)</span></span></code></pre></div>
<p>The next three variables have to do with zoom levels. MVTs are
simplified at lower zoom levels. As we’ve chosen not to display vector
data at lower zooms, we pick a fixed zoom to simplify caching and reduce
fetching redundant data. At zoom level 14, data are not simplified, so
that seems like a good choice.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data.zoom</span> <span class="op">&lt;-</span> <span class="fl">14</span>   <span class="co"># all MVT tiles are read at this zoom level to simplify caching</span></span></code></pre></div>
<p>Our trigger level is the zoom level to start showing vector data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">trigger</span> <span class="op">&lt;-</span> <span class="fl">14</span>     <span class="co"># show vector data when zoomed in this far or more</span></span></code></pre></div>
<p>This variable tells Leaflet the zoom levels at which to display the
vector data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">zoom.levels</span> <span class="op">=</span> <span class="fl">14</span><span class="op">:</span><span class="fl">22</span>    <span class="co"># show vector data at these zoom levels</span></span></code></pre></div>
<p>Finally, we can use functions from readMVT. [read.XML()] fetches the
GeoServer’s “capabilities” file, an XML with information on all data on
the GeoServer. Then, for each feature we will fetch, [layer.info()]
extracts an MVT object from the XML. Here, we get layer info for stream
linework and crossing (culverts and bridges) points.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xml</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.XML.html">read.XML</a></span><span class="op">(</span><span class="st">'https://umassdsl.webgis1.com/geoserver'</span><span class="op">)</span>   <span class="co"># get capabilities of our GeoServer</span></span>
<span><span class="va">streamlines</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer.info.html">layer.info</a></span><span class="op">(</span><span class="va">xml</span>, <span class="st">'testbed:streamlines'</span><span class="op">)</span>       <span class="co"># get info for stream linework</span></span>
<span><span class="va">culverts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer.info.html">layer.info</a></span><span class="op">(</span><span class="va">xml</span>, <span class="st">'testbed:CL_crossings7'</span><span class="op">)</span>        <span class="co"># get info for crossing points</span></span></code></pre></div>
<p>Here’s the MVT object for streamlines. It includes the layer name
(<em>layer</em>), the bounding box (<em>box</em>), the tile boundaries
at each zoom level (<em>tiles</em>), and a template URL that specifies
the tile to fetch, which unresolved information (zoom, row, and column)
enclosed in braces. In normal use of readMVT, you don’t need to worry
about these details–you just have to pass the result of [layer.info()]
to [read.tile()] or [read.viewport.tiles()].</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="sc">&gt;</span> streamlines</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>layer</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"testbed_streamlines"</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>box</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] <span class="sc">-</span><span class="fl">73.58043</span>  <span class="fl">41.22166</span> <span class="sc">-</span><span class="fl">69.89367</span>  <span class="fl">42.95567</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>tiles</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>   zoom    rowmin    rowmax    colmin    colmax</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="dv">1</span>     <span class="dv">0</span>         <span class="dv">0</span>         <span class="dv">0</span>         <span class="dv">0</span>         <span class="dv">0</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="dv">2</span>     <span class="dv">1</span>         <span class="dv">0</span>         <span class="dv">0</span>         <span class="dv">0</span>         <span class="dv">0</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="dv">3</span>     <span class="dv">2</span>         <span class="dv">1</span>         <span class="dv">1</span>         <span class="dv">1</span>         <span class="dv">1</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="dv">4</span>     <span class="dv">3</span>         <span class="dv">2</span>         <span class="dv">2</span>         <span class="dv">2</span>         <span class="dv">2</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="dv">5</span>     <span class="dv">4</span>         <span class="dv">5</span>         <span class="dv">5</span>         <span class="dv">4</span>         <span class="dv">4</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="dv">6</span>     <span class="dv">5</span>        <span class="dv">11</span>        <span class="dv">11</span>         <span class="dv">9</span>         <span class="dv">9</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="dv">7</span>     <span class="dv">6</span>        <span class="dv">23</span>        <span class="dv">23</span>        <span class="dv">18</span>        <span class="dv">19</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="dv">8</span>     <span class="dv">7</span>        <span class="dv">47</span>        <span class="dv">47</span>        <span class="dv">37</span>        <span class="dv">39</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="dv">9</span>     <span class="dv">8</span>        <span class="dv">94</span>        <span class="dv">95</span>        <span class="dv">75</span>        <span class="dv">78</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="dv">10</span>    <span class="dv">9</span>       <span class="dv">188</span>       <span class="dv">191</span>       <span class="dv">151</span>       <span class="dv">156</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="dv">11</span>   <span class="dv">10</span>       <span class="dv">376</span>       <span class="dv">383</span>       <span class="dv">302</span>       <span class="dv">313</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="dv">12</span>   <span class="dv">11</span>       <span class="dv">752</span>       <span class="dv">766</span>       <span class="dv">605</span>       <span class="dv">626</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  ...</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="dv">31</span>   <span class="dv">30</span> <span class="dv">394726401</span> <span class="dv">401696265</span> <span class="dv">317408725</span> <span class="dv">328404932</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="sc">$</span>url</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>[<span class="dv">1</span>] https<span class="sc">:</span><span class="er">//</span>umassdsl.webgis1.com<span class="sc">/</span>geoserver<span class="sc">/</span>gwc<span class="sc">/</span>service<span class="sc">/</span>wmts<span class="sc">/</span>rest<span class="sc">/</span>testbed<span class="sc">:</span>streamlines<span class="sc">/</span>simple_streams<span class="sc">/</span>EPSG<span class="sc">:</span><span class="dv">900913</span><span class="sc">/</span>EPSG<span class="sc">:</span><span class="dv">900913</span><span class="sc">:</span>{zoom}<span class="sc">/</span>{TileRow}<span class="sc">/</span>{TileCol}?format<span class="ot">=</span>application<span class="sc">/</span>vnd.mapbox<span class="sc">-</span>vector<span class="sc">-</span>tile</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="user-interface">User interface<a class="anchor" aria-label="anchor" href="#user-interface"></a>
</h3>
<p>Here’s a simple Shiny user interface. We make a sidebar on the left
to display the zoom level.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu">fluidPage</span><span class="op">(</span></span>
<span>   <span class="fu">fluidRow</span><span class="op">(</span></span>
<span>      <span class="fu">column</span><span class="op">(</span><span class="fl">2</span>,</span>
<span>             <span class="fu">wellPanel</span><span class="op">(</span></span>
<span>                <span class="fu">uiOutput</span><span class="op">(</span><span class="st">'dashboard'</span><span class="op">)</span></span>
<span>             <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu">column</span><span class="op">(</span><span class="fl">10</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-shiny.html" class="external-link">leafletOutput</a></span><span class="op">(</span><span class="st">'map'</span>, height <span class="op">=</span> <span class="st">'80vh'</span><span class="op">)</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="server">Server<a class="anchor" aria-label="anchor" href="#server"></a>
</h3>
<p>Now we’re ready for the guts of the example.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>server <span class="ot">&lt;-</span> <span class="cf">function</span>(input, output, session) {</span></code></pre></div>
<p>We display the Leaflet basemap and set the initial viewport. The ESRI
World Street Map makes a good basemap for this example, as the streams
match our vector streams.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">output</span><span class="op">$</span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-shiny.html" class="external-link">renderLeaflet</a></span><span class="op">(</span><span class="op">{</span></span>
<span>   <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html" class="external-link">leaflet</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/addProviderTiles.html" class="external-link">addProviderTiles</a></span><span class="op">(</span><span class="va">providers</span><span class="op">$</span><span class="va">Esri.WorldStreetMap</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-methods.html" class="external-link">setView</a></span><span class="op">(</span>lng <span class="op">=</span> <span class="va">home</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, lat <span class="op">=</span> <span class="va">home</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, zoom <span class="op">=</span> <span class="va">zoom</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Everything interesting happens inside an [leaflet::observe()]. First,
we display the zoom level in the left sidebar, and “TRIGGERED!” if the
zoom level is above the trigger. You should expect to see streams and
crossings with TRIGGERED is shown.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">observe</span>({</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>   output<span class="sc">$</span>dashboard <span class="ot">&lt;-</span> <span class="fu">renderUI</span>({</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>      output<span class="sc">$</span>dashboard <span class="ot">&lt;-</span> <span class="fu">renderUI</span>({</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">tagList</span>(<span class="fu">div</span>(<span class="st">'zoom = '</span>, input<span class="sc">$</span>map_zoom,),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>                 <span class="fu">div</span>(<span class="fu">strong</span>(<span class="cf">if</span>(<span class="fu">isTRUE</span>(input<span class="sc">$</span>map_zoom <span class="sc">&gt;=</span> trigger)) <span class="st">' TRIGGERED!'</span>)))</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>      })</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>   })</span></code></pre></div>
<p>If we’re zoomed out below the trigger zoom, we’re done–the basemap
will be displayed, but none of the vector data. If we’re zoomed above
(or equal to) the trigger, we’ll read the vector tiles and render them.
We use [leaflet::leafletProxy()] to modify the current display so
there’s no unnecessary (and ugly) redrawing.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">isTRUE</span>(input<span class="sc">$</span>map_zoom <span class="sc">&gt;=</span> trigger)) {   <span class="co"># if above trigger zoom, draw features</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>   m <span class="ot">&lt;-</span> <span class="fu">leafletProxy</span>(<span class="st">'map'</span>, session)</span></code></pre></div>
<p>We get the corner tiles of the current viewport at our fixed tile
zoom level from Leaflet.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.tile.html">get.tile</a></span><span class="op">(</span><span class="va">data.zoom</span>, <span class="va">input</span><span class="op">$</span><span class="va">map_bounds</span><span class="op">$</span><span class="va">north</span>, <span class="va">input</span><span class="op">$</span><span class="va">map_bounds</span><span class="op">$</span><span class="va">west</span><span class="op">)</span>   <span class="co"># corners of viewport</span></span>
<span><span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.tile.html">get.tile</a></span><span class="op">(</span><span class="va">data.zoom</span>, <span class="va">input</span><span class="op">$</span><span class="va">map_bounds</span><span class="op">$</span><span class="va">south</span>, <span class="va">input</span><span class="op">$</span><span class="va">map_bounds</span><span class="op">$</span><span class="va">east</span><span class="op">)</span></span></code></pre></div>
<p>Now we read all vector tiles for streams in the viewport, omitting
those we’ve already rendered. Rendering is captured by
<code>session$userData[[layername]]</code>. Initially, it will be NULL,
so <code>read.viewport.tiles</code> will initialize it. If you don’t
want to avoid redrawing, you can omit this argument and the following
line that saves it. If there are any vector data in the viewport that
haven’t yet been rendered, <code>addPolylines</code> renders these
streams.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.viewport.tiles.html">read.viewport.tiles</a></span><span class="op">(</span><span class="va">streamlines</span>, <span class="va">nw</span>, <span class="va">se</span>, <span class="va">data.zoom</span>, <span class="va">session</span><span class="op">$</span><span class="va">userData</span><span class="op">[[</span><span class="va">streamlines</span><span class="op">$</span><span class="va">layer</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">session</span><span class="op">$</span><span class="va">userData</span><span class="op">[[</span><span class="va">streamlines</span><span class="op">$</span><span class="va">layer</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">drawn</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">tiles</span><span class="op">)</span><span class="op">)</span></span>
<span>   <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html" class="external-link">addPolylines</a></span><span class="op">(</span><span class="va">m</span>, data <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">tiles</span>, group <span class="op">=</span> <span class="st">'vector'</span>, opacity <span class="op">=</span> <span class="fl">0.4</span>, color <span class="op">=</span> <span class="st">'cornflowerblue'</span>, weight <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<p>We do the same thing for culverts. Note that we could move culverts
into a separate if-clause with a different trigger if we wanted to.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.viewport.tiles.html">read.viewport.tiles</a></span><span class="op">(</span><span class="va">culverts</span>, <span class="va">nw</span>, <span class="va">se</span>, <span class="va">data.zoom</span>, <span class="va">session</span><span class="op">$</span><span class="va">userData</span><span class="op">[[</span><span class="va">culverts</span><span class="op">$</span><span class="va">layer</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">session</span><span class="op">$</span><span class="va">userData</span><span class="op">[[</span><span class="va">culverts</span><span class="op">$</span><span class="va">layer</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">drawn</span></span>
<span><span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">tiles</span><span class="op">)</span><span class="op">)</span></span>
<span>   <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html" class="external-link">addCircleMarkers</a></span><span class="op">(</span><span class="va">m</span>, data <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">tiles</span>, group <span class="op">=</span> <span class="st">'vector'</span>, opacity <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">'orange'</span>, radius <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<p>The call to [leaflet::groupOptions()]] displays all
previously-rendered vector data at the selected zoom levels. Without
this, zooming out would show streams and culverts for tiles we’ve
visited, but not other visible tiles. That would be ugly. By hiding the
vector data, they smoothly vanish as we zoom out. The Leaflet map is
returned and rendered as the [shiny::observe()] finishes.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">groupOptions</span>(m, <span class="st">'vector'</span>, <span class="at">zoomLevels =</span> zoom.levels))</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>      <span class="er">}</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>   <span class="er">})</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="fu">shinyApp</span>(ui, server)</span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="example-code-all-in-one-place">Example code, all in one place<a class="anchor" aria-label="anchor" href="#example-code-all-in-one-place"></a>
</h2>
<p>If you’re using RStudio, you should be able to install the named
packages, copy this code, paste it into a script window, save it, and
click “Run App.”</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bwcompton/readMVT" class="external-link">readMVT</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://shiny.posit.co/" class="external-link">shiny</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rstudio.github.io/leaflet/" class="external-link">leaflet</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">home</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">71.6995</span>, <span class="fl">42.1349</span><span class="op">)</span>  <span class="co"># center of Massachusetts</span></span>
<span><span class="va">zoom</span> <span class="op">&lt;-</span> <span class="fl">8</span>                     <span class="co"># starting zoom level (shows all of Massachusetts)</span></span>
<span></span>
<span><span class="va">data.zoom</span> <span class="op">&lt;-</span> <span class="fl">14</span>               <span class="co"># all MVT tiles are read at this zoom level to simplify caching</span></span>
<span><span class="va">trigger</span> <span class="op">&lt;-</span> <span class="fl">14</span>                 <span class="co"># show vector data when zoomed in this far or more</span></span>
<span><span class="va">zoom.levels</span> <span class="op">=</span> <span class="fl">14</span><span class="op">:</span><span class="fl">22</span>           <span class="co"># show vector data at these zoom levels</span></span>
<span></span>
<span><span class="va">xml</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.XML.html">read.XML</a></span><span class="op">(</span><span class="st">'https://umassdsl.webgis1.com/geoserver'</span><span class="op">)</span>   <span class="co"># get capabilities of our GeoServer</span></span>
<span><span class="va">streamlines</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer.info.html">layer.info</a></span><span class="op">(</span><span class="va">xml</span>, <span class="st">'testbed:streamlines'</span><span class="op">)</span>       <span class="co"># get info for stream linework</span></span>
<span><span class="va">culverts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/layer.info.html">layer.info</a></span><span class="op">(</span><span class="va">xml</span>, <span class="st">'testbed:CL_crossings7'</span><span class="op">)</span>        <span class="co"># get info for crossing points</span></span>
<span></span>
<span></span>
<span><span class="co"># User interface ---------------------</span></span>
<span><span class="va">ui</span> <span class="op">&lt;-</span> <span class="fu">fluidPage</span><span class="op">(</span></span>
<span>   <span class="fu">fluidRow</span><span class="op">(</span></span>
<span>      <span class="fu">column</span><span class="op">(</span><span class="fl">2</span>,</span>
<span>             <span class="fu">wellPanel</span><span class="op">(</span></span>
<span>                <span class="fu">uiOutput</span><span class="op">(</span><span class="st">'dashboard'</span><span class="op">)</span></span>
<span>             <span class="op">)</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="fu">column</span><span class="op">(</span><span class="fl">10</span>,</span>
<span>             <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-shiny.html" class="external-link">leafletOutput</a></span><span class="op">(</span><span class="st">'map'</span>, height <span class="op">=</span> <span class="st">'80vh'</span><span class="op">)</span></span>
<span>      <span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co"># Server -----------------------------</span></span>
<span><span class="va">server</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">input</span>, <span class="va">output</span>, <span class="va">session</span><span class="op">)</span> <span class="op">{</span></span>
<span></span>
<span></span>
<span>   <span class="va">output</span><span class="op">$</span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-shiny.html" class="external-link">renderLeaflet</a></span><span class="op">(</span><span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leaflet.html" class="external-link">leaflet</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>         <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/addProviderTiles.html" class="external-link">addProviderTiles</a></span><span class="op">(</span><span class="va">providers</span><span class="op">$</span><span class="va">Esri.WorldStreetMap</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>         <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-methods.html" class="external-link">setView</a></span><span class="op">(</span>lng <span class="op">=</span> <span class="va">home</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, lat <span class="op">=</span> <span class="va">home</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, zoom <span class="op">=</span> <span class="va">zoom</span><span class="op">)</span></span>
<span>   <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>   <span class="fu">observe</span><span class="op">(</span><span class="op">{</span></span>
<span>      <span class="va">output</span><span class="op">$</span><span class="va">dashboard</span> <span class="op">&lt;-</span> <span class="fu">renderUI</span><span class="op">(</span><span class="op">{</span></span>
<span>         <span class="va">output</span><span class="op">$</span><span class="va">dashboard</span> <span class="op">&lt;-</span> <span class="fu">renderUI</span><span class="op">(</span><span class="op">{</span></span>
<span>            <span class="fu">tagList</span><span class="op">(</span><span class="fu">div</span><span class="op">(</span><span class="st">'zoom = '</span>, <span class="va">input</span><span class="op">$</span><span class="va">map_zoom</span>,<span class="op">)</span>,</span>
<span>                    <span class="fu">div</span><span class="op">(</span><span class="fu">strong</span><span class="op">(</span><span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">map_zoom</span> <span class="op">&gt;=</span> <span class="va">trigger</span><span class="op">)</span><span class="op">)</span> <span class="st">' TRIGGERED!'</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>         <span class="op">}</span><span class="op">)</span></span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">input</span><span class="op">$</span><span class="va">map_zoom</span> <span class="op">&gt;=</span> <span class="va">trigger</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>   <span class="co"># if above trigger zoom, draw features</span></span>
<span>         <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/leafletProxy.html" class="external-link">leafletProxy</a></span><span class="op">(</span><span class="st">'map'</span>, <span class="va">session</span><span class="op">)</span></span>
<span>         </span>
<span>         <span class="va">nw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.tile.html">get.tile</a></span><span class="op">(</span><span class="va">data.zoom</span>, <span class="va">input</span><span class="op">$</span><span class="va">map_bounds</span><span class="op">$</span><span class="va">north</span>, <span class="va">input</span><span class="op">$</span><span class="va">map_bounds</span><span class="op">$</span><span class="va">west</span><span class="op">)</span>   <span class="co"># corners of viewport</span></span>
<span>         <span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get.tile.html">get.tile</a></span><span class="op">(</span><span class="va">data.zoom</span>, <span class="va">input</span><span class="op">$</span><span class="va">map_bounds</span><span class="op">$</span><span class="va">south</span>, <span class="va">input</span><span class="op">$</span><span class="va">map_bounds</span><span class="op">$</span><span class="va">east</span><span class="op">)</span></span>
<span></span>
<span>         <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.viewport.tiles.html">read.viewport.tiles</a></span><span class="op">(</span><span class="va">streamlines</span>, <span class="va">nw</span>, <span class="va">se</span>, <span class="va">data.zoom</span>, <span class="va">session</span><span class="op">$</span><span class="va">userData</span><span class="op">[[</span><span class="va">streamlines</span><span class="op">$</span><span class="va">layer</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>         <span class="va">session</span><span class="op">$</span><span class="va">userData</span><span class="op">[[</span><span class="va">streamlines</span><span class="op">$</span><span class="va">layer</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">drawn</span></span>
<span>         <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">tiles</span><span class="op">)</span><span class="op">)</span></span>
<span>            <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html" class="external-link">addPolylines</a></span><span class="op">(</span><span class="va">m</span>, data <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">tiles</span>, group <span class="op">=</span> <span class="st">'vector'</span>, opacity <span class="op">=</span> <span class="fl">0.4</span>, color <span class="op">=</span> <span class="st">'cornflowerblue'</span>, weight <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span></span>
<span>         <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read.viewport.tiles.html">read.viewport.tiles</a></span><span class="op">(</span><span class="va">culverts</span>, <span class="va">nw</span>, <span class="va">se</span>, <span class="va">data.zoom</span>, <span class="va">session</span><span class="op">$</span><span class="va">userData</span><span class="op">[[</span><span class="va">culverts</span><span class="op">$</span><span class="va">layer</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>         <span class="va">session</span><span class="op">$</span><span class="va">userData</span><span class="op">[[</span><span class="va">culverts</span><span class="op">$</span><span class="va">layer</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">drawn</span></span>
<span>         <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">tiles</span><span class="op">)</span><span class="op">)</span></span>
<span>            <span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/map-layers.html" class="external-link">addCircleMarkers</a></span><span class="op">(</span><span class="va">m</span>, data <span class="op">=</span> <span class="va">x</span><span class="op">$</span><span class="va">tiles</span>, group <span class="op">=</span> <span class="st">'vector'</span>, opacity <span class="op">=</span> <span class="fl">1</span>, color <span class="op">=</span> <span class="st">'orange'</span>, radius <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span>         <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/leaflet/man/groupOptions.html" class="external-link">groupOptions</a></span><span class="op">(</span><span class="va">m</span>, <span class="st">'vector'</span>, zoomLevels <span class="op">=</span> <span class="va">zoom.levels</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>   <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">shinyApp</span><span class="op">(</span><span class="va">ui</span>, <span class="va">server</span><span class="op">)</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Bradley W. Compton.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
